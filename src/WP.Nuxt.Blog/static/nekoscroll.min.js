;
(function ($) {
  function getBasicInfo() {
    var ViewH = $(window).height();
    var DocH = $("body")[0].scrollHeight;
    var ScrollTop = $(window).scrollTop();
    var S_V = DocH - ViewH;
    var Band_H = ScrollTop / (DocH - ViewH) * 100;
    return {
      ViewH: ViewH,
      DocH: DocH,
      ScrollTop: ScrollTop,
      Band_H: Band_H,
      S_V: S_V
    }
  }
  $.fn.nekoScroll = function (option) {
    var defaultSetting = {
      top: '0',
      scroWidth: 6 + 'px',
      bgcolor: "#2f3542",
      z_index: 9999,
      zoom: 0.9,
      borderRadius: 5 + 'px',
      right: 32 + 'px',
      nekoImg: "/images/cat.png",
      scImg: "/images/sheng.png",
      hoverMsg: "喵喵？",
      endMsg: "已经读完了",
      fontFamily: "",
      nekoname: "neko",
      fontSize: "",
      color: "#333",
      during: 600,
      blog_body: "body",
      catalog_item: "h3",
      readColor: "#109DFF",
      unreadColor: "#2f3542"
    }
    var setting = $.extend(defaultSetting, option);
    var getThis = this.prop("className") !== "" ? "." + this.prop("className") : this.prop("id") !== "" ? "#" + this.prop("id") : this.prop("nodeName");
    this.after("<div class=\"neko\" id=" + setting.nekoname + " data-msg=\"" + setting.hoverMsg + "\"></div>");
    let basicInfo = getBasicInfo();
    $(getThis).css({
      'position': 'fixed',
      'width': setting.scroWidth,
      'top': setting.top,
      'height': basicInfo.Band_H * setting.zoom + '%',
      'z-index': setting.z_index,
      'background-color': setting.bgcolor,
      "border-radius": setting.borderRadius,
      'right': setting.right,
      'background-image': 'url(' + setting.scImg + ')',
      'background-size': 'contain'
    });
    $("#" + setting.nekoname).css({
      'position': 'fixed',
      'top': (basicInfo.Band_H * setting.zoom * 8 / 9) + '%',
      'z-index': setting.z_index * 10,
      'right': setting.right,
      'background-image': 'url(' + setting.nekoImg + ')',
      'font-family': setting.fontFamily,
      'font-size': setting.fontSize,
      'color': setting.color
    });
    $(window).scroll(function () {
      let basicInfo = getBasicInfo();
      $(getThis).css({
        'position': 'fixed',
        'width': setting.scroWidth,
        'top': setting.top,
        'height': basicInfo.Band_H * setting.zoom + '%',
        'z-index': setting.z_index,
        'background-color': setting.bgcolor,
        "border-radius": setting.borderRadius,
        'right': setting.right,
        'background-image': 'url(' + setting.scImg + ')',
        'background-size': 'contain'
      });
      $("#" + setting.nekoname).css({
        'position': 'fixed',
        'top': (basicInfo.Band_H * setting.zoom * 8 / 9) + '%',
        'z-index': setting.z_index * 10,
        'right': setting.right,
        'background-image': 'url(' + setting.nekoImg + ')',
        'font-family': setting.fontFamily,
        'font-size': setting.fontSize
      });
      if (basicInfo.ScrollTop == basicInfo.S_V) {
        $("#" + setting.nekoname).attr("data-msg", setting.endMsg);
        $("#" + setting.nekoname).addClass("showMsg")
      } else {
        $("#" + setting.nekoname).removeClass("showMsg");
        $("#" + setting.nekoname).attr("data-msg", setting.hoverMsg);
      }
      changeCatalog();
    });
    this.click(function (e) {
      var basicInfo = getBasicInfo();
      var x = e.clientX;
      var y = e.clientY;
      var Band_H = basicInfo.Band_H * setting.zoom;
      var ViewH = basicInfo.ViewH;
      var S_V = basicInfo.S_V;
      var move = 0;
      if (Band_H * ViewH / 100 > y) {
        move = (Band_H * ViewH / 100 - y) / (ViewH * setting.zoom) * S_V;
      }
      var moveStr = "-=" + move
      $("html,body").animate({
        scrollTop: moveStr
      }, setting.during / 2);
    });
    $("#" + setting.nekoname).click(function () {
      var scroT = $(window).scrollTop();
      var scroH = $('body')[0].scrollHeight;
      var ViewH = $(window).height();
      var S_V = "+=" + (scroH - ViewH);
      var mv = "-=" + scroT;
      if (scroT == 0) {
        $("html,body").animate({
          scrollTop: S_V
        }, setting.during);
      } else {
        $("html,body").animate({
          scrollTop: mv+70
        }, setting.during);
      }
    });
    $("#catalog-box").click(function (e) {
      e.stopPropagation();
    });

    function setCatalog() {
      console.log($(setting.blog_body + " " + setting.catalog_item).length);
      $(setting.blog_body + " " + setting.catalog_item).each(function (index) {
        $(this).attr("id", "myuki-catalog-item" + index);
      });
    }

    function createCatalog() {
      $(setting.blog_body + " " + setting.catalog_item).each(function (index) {
        let newCatalogItem = "<li class=\"catalog-list-item\" title=\"" + $(this).text() + "\"><a href=\"#" + $(this).attr("id") + "\">" + $(this).text() + "</a></li>";
        $("#catalog-box .catalog-list").append(newCatalogItem);
      });
    }

    function changeCatalog() {
      $(".catalog-list-item a").css("color", setting.unreadColor);
      $(".catalog-item").each(function (index) {
        if (document.getElementById($(this).attr("id")).getBoundingClientRect().top <= 10) {
          $(".catalog-list-item:eq(" + index + ") a").css("color", setting.readColor);
        } else {
          $(".catalog-list-item:eq(" + index + ") a").css("color", setting.unreadColor);
        }
      });
    }
    setCatalog();
    createCatalog();
    changeCatalog();
    $(".catalog-list-item").each(function () {
      let catalogStr = $(this).text();
      $(this).on("mouseover", function (e) {
        e.stopPropagation();
        $(this).css("width", "250%");
        $("#" + setting.nekoname).attr("data-msg", catalogStr);
      });
      $(this).on("mouseout", function (e) {
        e.stopPropagation();
        $(this).css("width", "100%");
        $("#" + setting.nekoname).attr("data-msg", setting.hoverMsg);
      });
    });
    return this;
  }
})(jQuery);
